<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark Attendance - AttendPro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div class="page-wrapper">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="logo-icon">ğŸ“š</div>
                <h2>AttendPro</h2>
            </div>
            <ul class="nav-menu">
                <li class="nav-item"><a href="attendance.html" class="nav-link active"><span
                            class="icon">âœ“</span><span>Mark Attendance</span></a></li>
                <li class="nav-item"><a href="students.html" class="nav-link"><span class="icon">ğŸ‘¥</span><span>View
                            Students</span></a></li>
                <li class="nav-item"><a href="register.html" class="nav-link"><span class="icon">â•</span><span>Register
                            Student</span></a></li>
                <li class="nav-item"><a href="view-attendance.html" class="nav-link"><span
                            class="icon">ğŸ“Š</span><span>View Attendance</span></a></li>
                <li class="nav-item admin-only hidden"><a href="admin.html" class="nav-link"><span
                            class="icon">âš™ï¸</span><span>Admin Dashboard</span></a></li>
            </ul>
            <div class="sidebar-footer"><a href="#" class="nav-link" id="logoutBtn"><span
                        class="icon">ğŸšª</span><span>Logout</span></a></div>
        </aside>
        <main class="main-content">
            <div class="page-header">
                <h1>Mark Attendance</h1>
                <p>Select class and date to mark attendance</p>
            </div>
            <div class="card mb-3">
                <div class="form-row">
                    <div class="form-group" style="margin-bottom:0;">
                        <label class="form-label">Class</label>
                        <select id="classSelect" class="form-control">
                            <option value="">Choose...</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <label class="form-label">Date</label>
                        <input type="date" id="dateSelect" class="form-control">
                    </div>
                    <div class="form-group" style="margin-bottom:0;display:flex;align-items:flex-end;">
                        <button class="btn btn-primary" onclick="loadStudents()">Load</button>
                    </div>
                </div>
            </div>
            <div id="alertBox" class="alert hidden"></div>
            <div class="card" id="attendanceCard" style="display:none;">
                <div class="card-header">
                    <h3 class="card-title"><span id="info"></span></h3>
                    <div><button class="btn btn-outline btn-sm" onclick="markAll('present')">All Present</button>
                        <button class="btn btn-outline btn-sm" onclick="markAll('absent')">All Absent</button>
                    </div>
                </div>
                <div class="attendance-grid" id="list"></div>
                <div class="mt-3"><button class="btn btn-success btn-block" onclick="save()">ğŸ’¾ Save</button></div>
            </div>
        </main>
    </div>
    <script src="js/config.js"></script>
    <script src="js/app.js"></script>
    <script>
        checkAuth();
        document.getElementById('dateSelect').valueAsDate = new Date();
        let students = [], data = {};
        async function init() {
            const r = await fetchAPI('/classes');
            const c = await r.json();
            document.getElementById('classSelect').innerHTML = '<option value="">Choose...</option>' + c.map(x => `<option>${x}</option>`).join('');
        }
        async function loadStudents() {
            const cls = document.getElementById('classSelect').value;
            const dt = document.getElementById('dateSelect').value;
            if (!cls || !dt) { showAlert(document.getElementById('alertBox'), 'Select class and date', 'warning'); return; }
            const r = await fetchAPI(`/students?class=${encodeURIComponent(cls)}`);
            students = await r.json();
            if (!students.length) { showAlert(document.getElementById('alertBox'), 'No students', 'warning'); return; }
            const ar = await fetchAPI(`/attendance?class=${encodeURIComponent(cls)}&date=${dt}`);
            const att = await ar.json();
            data = {};
            att.forEach(a => data[a.student_id] = a.status);
            students.forEach(s => { if (!data[s.id]) data[s.id] = 'present'; });
            render();
            document.getElementById('info').textContent = `${cls} - ${new Date(dt).toLocaleDateString()}`;
            document.getElementById('attendanceCard').style.display = 'block';
        }
        function render() {
            document.getElementById('list').innerHTML = students.map(s => `
                <div class="attendance-item">
                    <div class="student-info"><div class="student-avatar">${s.name[0]}</div>
                    <div class="student-details"><h4>${s.name}</h4><p>Roll: ${s.roll_number}</p></div></div>
                    <div class="attendance-toggle">
                        <button class="toggle-btn present ${data[s.id] === 'present' ? 'active' : ''}" onclick="toggle(${s.id},'present')">âœ“</button>
                        <button class="toggle-btn absent ${data[s.id] === 'absent' ? 'active' : ''}" onclick="toggle(${s.id},'absent')">âœ•</button>
                    </div>
                </div>`).join('');
        }
        function toggle(id, st) { data[id] = st; render(); }
        function markAll(st) { students.forEach(s => data[s.id] = st); render(); }
        async function save() {
            const r = await fetchAPI('/attendance', { method: 'POST', body: JSON.stringify({ date: document.getElementById('dateSelect').value, attendance: students.map(s => ({ student_id: s.id, status: data[s.id] })) }) });
            showAlert(document.getElementById('alertBox'), r.ok ? 'Saved!' : 'Error', r.ok ? 'success' : 'danger');
        }
        init();
    </script>
</body>

</html>