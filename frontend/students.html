<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Students - Attendance Management System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div class="page-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="logo-icon">ğŸ“š</div>
                <h2>AttendPro</h2>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="attendance.html" class="nav-link">
                        <span class="icon">âœ“</span>
                        <span>Mark Attendance</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="students.html" class="nav-link active">
                        <span class="icon">ğŸ‘¥</span>
                        <span>View Students</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="register.html" class="nav-link">
                        <span class="icon">â•</span>
                        <span>Register Student</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="view-attendance.html" class="nav-link">
                        <span class="icon">ğŸ“Š</span>
                        <span>View Attendance</span>
                    </a>
                </li>
                <li class="nav-item admin-only hidden">
                    <a href="admin.html" class="nav-link">
                        <span class="icon">âš™ï¸</span>
                        <span>Admin Dashboard</span>
                    </a>
                </li>
            </ul>
            <div class="sidebar-footer">
                <a href="#" class="nav-link" id="logoutBtn">
                    <span class="icon">ğŸšª</span>
                    <span>Logout</span>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1>Students List</h1>
                <p>View all registered students by class</p>
            </div>

            <!-- Filters -->
            <div class="card mb-3">
                <div class="d-flex gap-2 align-center">
                    <div class="form-group" style="margin-bottom: 0; flex: 1; max-width: 300px;">
                        <select id="classFilter" class="form-control">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0; flex: 1; max-width: 300px;">
                        <input type="text" id="searchInput" class="form-control"
                            placeholder="Search by name or roll number...">
                    </div>
                </div>
            </div>

            <!-- Students Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon primary">ğŸ‘¥</div>
                    <div class="stat-info">
                        <h3 id="totalStudents">0</h3>
                        <p>Total Students</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon success">ğŸ“š</div>
                    <div class="stat-info">
                        <h3 id="totalClasses">0</h3>
                        <p>Total Classes</p>
                    </div>
                </div>
            </div>

            <!-- Students Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Student Records</h3>
                    <a href="register.html" class="btn btn-primary btn-sm">â• Add New</a>
                </div>
                <div class="table-container">
                    <table class="table" id="studentsTable">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Roll Number</th>
                                <th>Class</th>
                                <th>Registered On</th>
                                <th class="admin-only hidden">Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="js/config.js"></script>
    <script src="js/app.js"></script>
    <script>
        checkAuth();

        let allStudents = [];

        async function loadStudents() {
            try {
                const response = await fetchAPI('/students');
                allStudents = await response.json();

                document.getElementById('totalStudents').textContent = allStudents.length;

                // Get unique classes
                const classes = [...new Set(allStudents.map(s => s.class))].sort();
                document.getElementById('totalClasses').textContent = classes.length;

                // Populate class filter
                const classFilter = document.getElementById('classFilter');
                classFilter.innerHTML = '<option value="">All Classes</option>' +
                    classes.map(c => `<option value="${c}">${c}</option>`).join('');

                renderStudents(allStudents);
            } catch (error) {
                console.error('Error loading students:', error);
            }
        }

        function renderStudents(students) {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const isAdmin = user.role === 'admin';

            const tbody = document.querySelector('#studentsTable tbody');
            tbody.innerHTML = students.map(s => `
                <tr>
                    <td>
                        <div class="d-flex align-center gap-2">
                            <div class="student-avatar" style="width:36px;height:36px;font-size:0.875rem;">
                                ${s.name.charAt(0).toUpperCase()}
                            </div>
                            <span>${s.name}</span>
                        </div>
                    </td>
                    <td><code>${s.roll_number}</code></td>
                    <td><span class="badge badge-primary">${s.class}</span></td>
                    <td>${new Date(s.created_at).toLocaleDateString()}</td>
                    ${isAdmin ? `
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteStudent(${s.id})">ğŸ—‘ï¸</button>
                        </td>
                    ` : ''}
                </tr>
            `).join('') || '<tr><td colspan="5" class="text-center text-muted">No students found</td></tr>';
        }

        function filterStudents() {
            const classFilter = document.getElementById('classFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            let filtered = allStudents;

            if (classFilter) {
                filtered = filtered.filter(s => s.class === classFilter);
            }

            if (search) {
                filtered = filtered.filter(s =>
                    s.name.toLowerCase().includes(search) ||
                    s.roll_number.toLowerCase().includes(search)
                );
            }

            renderStudents(filtered);
        }

        async function deleteStudent(id) {
            if (!confirm('Are you sure you want to delete this student?')) return;

            try {
                const response = await fetchAPI(`/students/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    loadStudents();
                }
            } catch (error) {
                console.error('Error deleting student:', error);
            }
        }

        document.getElementById('classFilter').addEventListener('change', filterStudents);
        document.getElementById('searchInput').addEventListener('input', filterStudents);

        loadStudents();
    </script>
</body>

</html>